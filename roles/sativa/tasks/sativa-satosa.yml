# Deploy Satosa and dependencies (configuration file, secrets) to OpenShift
- tags: all
  include_vars: sativa-vars.yml

- name: ConfigMap for Satosa
  openshift:
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: satosa
      namespace: "{{ openshift_namespace }}"
    data:
      proxy_conf.yaml: >-
        {{ lookup("template", "proxy_conf.yaml") }}

- name: DeploymentConfig for Satosa
  openshift:
    apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      name: sativa
      namespace: '{{ openshift_namespace }}'
    spec:
      replicas: 1
      selector:
        deployment-config.name: sativa
      # `strategy:` configures resources and other parameters for
      # the upgrade process.
      strategy:
        resources:
          limits:
            memory: 100Mi
      template:
        metadata:
          labels:
            deployment-config.name: sativa
        spec:
          containers:
            - name: satosa
              image: "{{ satosa_image }}"
              resources:
                limits:
                  memory: 100Mi
                requests:
                  memory: 50Mi
              volumes:
                # TODO: ${PWD}/satosa:/data
